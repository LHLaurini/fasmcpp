<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fasmcpp: Getting started</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">fasmcpp
   &#160;<span id="projectnumber">0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Getting started </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#gs_include">Including fasmcpp</a></li>
<li class="level1"><a href="#gs_initialize">Initializing fasmcpp</a></li>
<li class="level1"><a href="#gs_specify">Specifying the code to be compiled</a></li>
<li class="level1"><a href="#gs_analyze">A detailed analysis of the code</a><ul><li class="level2"><a href="#gsa_win64">Windows (x64)</a></li>
<li class="level2"><a href="#gsa_win32">Windows (x86)</a></li>
</ul>
</li>
<li class="level1"><a href="#gs_assemble">Assembling</a></li>
<li class="level1"><a href="#gs_run">Running</a></li>
<li class="level1"><a href="#gs_error">Getting errors</a></li>
<li class="level1"><a href="#gs_entirecode">The entire code</a></li>
</ul>
</div>
<div class="textblock"><p>This page will guide you through writing a simple "Hello, world!" application using fasmcpp. We'll go through the basics of fasmcpp.</p>
<h1><a class="anchor" id="gs_include"></a>
Including fasmcpp</h1>
<p>To include fasmcpp in your source files, you only need to include a single header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fasmcpp.h&gt;</span></div></div><!-- fragment --><p>All public symbols defined in <a class="el" href="fasmcpp_8h_source.html">fasmcpp.h</a> are enclosed in the namespace fasmcpp. <a class="el" href="fasmcpp_8h_source.html">fasmcpp.h</a> includes few other files and some needed headers from the C++ standard library.</p>
<p>Since we're writing a "Hello, world!", we're going to need a function to show our message. We're going to use <code>printf</code> from assembly and <code>std::cout</code> from C++ to display eventual errors.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div></div><!-- fragment --><p>We're also going to use an optional <code>using namespace</code> to enable a small helper which we're going to see more about soon.</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacefasmcpp_1_1size__multipliers.html">fasmcpp::size_multipliers</a>;</div></div><!-- fragment --><h1><a class="anchor" id="gs_initialize"></a>
Initializing fasmcpp</h1>
<p>Initializing fasmcpp is simple. You just have to create an instance of the <a class="el" href="classfasmcpp_1_1_assembler.html" title="Manages resources for Flat Assembler. ">fasmcpp::Assembler</a> class and specify how much memory you want to allocate for the assembler. Note, however, that in some platforms you must create no more than one instance or else an exception will be thrown.</p>
<p>Also, here's our little helper. It converts automatically to bytes and in this case is equivalent to 102400. A KB is 1024 bytes, a MB is 1024 KB and a GB is 1024 MB. Larger multipliers such as TB aren't needed because FASM is written in x86 and has limited access to memory.</p>
<div class="fragment"><div class="line"><a class="code" href="classfasmcpp_1_1_assembler.html">fasmcpp::Assembler</a> assembler;</div><div class="line"></div><div class="line"><span class="keywordflow">try</span></div><div class="line">{</div><div class="line">    assembler = 100_KB;</div><div class="line">}</div></div><!-- fragment --><p>The constructor can fail by throwing an exception even if we do everything right, so we have to construct it in a try block. That's needed because in some platforms the assembler must be loaded into a fixed address in memory (0x10000 by default, but it can be changed in CMake) and that address may be unavailable.</p>
<p>Our catch block just shows the error and exits with an error code.</p>
<div class="fragment"><div class="line"><span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="gs_specify"></a>
Specifying the code to be compiled</h1>
<p>To specify the code we want to compile, we must first create an <a class="el" href="classfasmcpp_1_1_assembly.html" title="Contains assembly code and its bytecode and predefinitions. ">fasmcpp::Assembly</a> class. We are going to first create an empty one...</p>
<div class="fragment"><div class="line"><a class="code" href="classfasmcpp_1_1_assembly.html">fasmcpp::Assembly</a> helloWorld;</div></div><!-- fragment --><p>...And then we're going to set our code. Note that each target platform needs specific code.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if defined _WIN64</span></div><div class="line">    helloWorld = <span class="stringliteral">&quot;\</span></div><div class="line"><span class="stringliteral">        use64 \n\</span></div><div class="line"><span class="stringliteral">        sub rsp, 5*8 \n\</span></div><div class="line"><span class="stringliteral">        lea rcx, [string] \n\</span></div><div class="line"><span class="stringliteral">        call [_printf] \n\</span></div><div class="line"><span class="stringliteral">        add rsp, 5*8 \n\</span></div><div class="line"><span class="stringliteral">        ret \n\</span></div><div class="line"><span class="stringliteral">        _printf dq printf \n\</span></div><div class="line"><span class="stringliteral">        string db &#39;Hello world (from assembly)!&#39;, 13, 10, 0 \n\</span></div><div class="line"><span class="stringliteral">    &quot;</span>;</div><div class="line"><span class="preprocessor">#elif defined _WIN32</span></div><div class="line">    helloWorld = <span class="stringliteral">&quot;\</span></div><div class="line"><span class="stringliteral">        use32 \n\</span></div><div class="line"><span class="stringliteral">        call $+5 \n\</span></div><div class="line"><span class="stringliteral">        mov eax, [esp] \n\</span></div><div class="line"><span class="stringliteral">        add dword[esp], string-5 \n\</span></div><div class="line"><span class="stringliteral">        call [eax+_printf-5] \n\</span></div><div class="line"><span class="stringliteral">        add esp, 4 \n\</span></div><div class="line"><span class="stringliteral">        ret \n\</span></div><div class="line"><span class="stringliteral">        _printf dd printf \n\</span></div><div class="line"><span class="stringliteral">        string db &#39;Hello world (from assembly)!&#39;, 13, 10, 0 \n\</span></div><div class="line"><span class="stringliteral">    &quot;</span>;</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><h1><a class="anchor" id="gs_analyze"></a>
A detailed analysis of the code</h1>
<p>We're going to analyze the code we're going to compile. Here I've extracted only the content of the string we're passing. Keep in mind that <b>we don't know what address the code is going to be executed from</b>, so our code <b>must be position-independent</b>.</p>
<p>You should be familiar with assembly, the FASM syntax and the calling conventions before continuing.</p>
<h2><a class="anchor" id="gsa_win64"></a>
Windows (x64)</h2>
<p>We start by declaring the desired instruction set. </p><div class="fragment"><div class="line">use64</div></div><!-- fragment --><p>We must reserve enough space on the stack for the functions we're going to call to be able to store the parameters, plus 16-byte alignment. </p><div class="fragment"><div class="line">sub rsp, 5*8</div></div><!-- fragment --><p>We pass the first and only argument through the <code>RCX</code> register. Note that we must use <code>lea</code> instead of <code>mov</code> to pass pointers because <code>lea</code> uses a relative address to calculate an absolute one, while <code>mov</code> just copies the relative address into the destination. </p><div class="fragment"><div class="line">lea rcx, [string]</div></div><!-- fragment --><p>Then we call <code>printf</code>, leave the stack pointer as we found it and return. </p><div class="fragment"><div class="line">call [_printf]</div><div class="line">add rsp, 5*8</div><div class="line">ret</div></div><!-- fragment --><p>We define the variable <code>_printf</code> which is initialized with a pointer to the <code>printf</code> function that we're going to supply later. </p><div class="fragment"><div class="line">_printf dq printf</div></div><!-- fragment --><p>And then we define our "Hello, world!" string. </p><div class="fragment"><div class="line"><span class="keywordtype">string</span> db <span class="stringliteral">&quot;Hello world (from assembly)!&quot;</span>, 13, 10, 0</div></div><!-- fragment --><h2><a class="anchor" id="gsa_win32"></a>
Windows (x86)</h2>
<p>We start by declaring the desired instruction set. </p><div class="fragment"><div class="line">use32</div></div><!-- fragment --><p>Now we need to know <code>EIP</code> so we can do relative addressing, but we can't do <code>mov eax, eip</code>. So we call the next instruction and the CPU will push <code>EIP</code> to the stack. </p><div class="fragment"><div class="line">call $+5</div></div><!-- fragment --><p><code>[ESP]</code> is the location our code was loaded to, plus five. So we set our string on the stack and call <code>printf</code>. </p><div class="fragment"><div class="line">mov eax, [esp]</div><div class="line">add dword[esp], <span class="keywordtype">string</span>-5</div><div class="line">call [eax+_printf-5]</div></div><!-- fragment --><p><code>printf</code> is <code>__cdecl</code> which means we have to clean up the stack for the arguments we pass. </p><div class="fragment"><div class="line">add esp, 4</div><div class="line">ret</div></div><!-- fragment --><p>We define the variable <code>_printf</code> which is initialized with a pointer to the <code>printf</code> function that we're going to supply later. </p><div class="fragment"><div class="line">_printf dq printf</div></div><!-- fragment --><p>And then we define our "Hello, world!" string. </p><div class="fragment"><div class="line"><span class="keywordtype">string</span> db <span class="stringliteral">&quot;Hello world (from assembly)!&quot;</span>, 13, 10, 0</div></div><!-- fragment --><h1><a class="anchor" id="gs_assemble"></a>
Assembling</h1>
<p>Before we assemble, we need to first set our Assembler so Assembly knows where to store data during the assembling process.</p>
<div class="fragment"><div class="line">helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a6c8a3c1f474cea832620ca349bfafbc7">setAssembler</a>(&amp;assembler);</div></div><!-- fragment --><p>Also, we have to tell the FASM preprocessor to replace the <code>printf</code> symbol with the pointer to the actual function. </p><div class="fragment"><div class="line">helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a302b52f86108409b025403e7bb342c04">addPredefinition</a>(<span class="stringliteral">&quot;printf&quot;</span>, printf);</div></div><!-- fragment --><p>Now we're ready to assemble. To do so, just call: </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> success = helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#aff60920cd801271fa67d52a106ebd2b8">assemble</a>();</div></div><!-- fragment --><p>Instead of throwing exceptions when it finds errors in the code, <code>assemble</code> returns <code>false</code>.</p>
<h1><a class="anchor" id="gs_run"></a>
Running</h1>
<p>If the compilation was successful we can run it. Note however that the <code>run</code> method receives a <code>bool</code> parameter. If <code>true</code>, <code>run</code> saves all non-volatile registers in the stack, depending on the platform and calling convention. If <code>false</code>, <code>run</code> just runs our code. It's recommended for you to be aware of the non-volatile registers, back them up manually and call <code>run</code> with a <code>false</code> argument. </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (success)</div><div class="line">{</div><div class="line">    helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a09851233625bdcd5f357c1793e35254d">run</a>(<span class="keyword">false</span>);</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="gs_error"></a>
Getting errors</h1>
<p>If the compilation wasn't successful we have to see what's wrong. To do so we call the <code>getErrors</code> method which returns a string describing the error. Our code, however, is correct and should succeed. </p><div class="fragment"><div class="line"><span class="keywordflow">else</span></div><div class="line">{</div><div class="line">    std::cout &lt;&lt; helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a909faa2c985dd39abe77103dd66014d1">getErrors</a>() &lt;&lt; std::endl;</div><div class="line">}</div></div><!-- fragment --><p>If you wish to test this bit of code, you can modify the assembly code and make an intentional typo, or even just comment out <code>helloWorld.addPredefinition("printf", printf);</code>.</p>
<h1><a class="anchor" id="gs_entirecode"></a>
The entire code</h1>
<p>Here is everything put together, plus some time measurements. You can find this in example.cpp.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;fasmcpp.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span>std::chrono;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacefasmcpp_1_1size__multipliers.html">fasmcpp::size_multipliers</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    <a class="code" href="classfasmcpp_1_1_assembler.html">fasmcpp::Assembler</a> assembler;</div><div class="line"></div><div class="line">    <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">        assembler = 100_KB;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e)</div><div class="line">    {</div><div class="line">        std::cout &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">        std::cin.get();</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="classfasmcpp_1_1_assembly.html">fasmcpp::Assembly</a> helloWorld;</div><div class="line"></div><div class="line"><span class="preprocessor">#if defined _WIN64</span></div><div class="line">    helloWorld = <span class="stringliteral">&quot;\</span></div><div class="line"><span class="stringliteral">        use64 \n\</span></div><div class="line"><span class="stringliteral">        sub rsp, 5*8 \n\</span></div><div class="line"><span class="stringliteral">        lea rcx, [string] \n\</span></div><div class="line"><span class="stringliteral">        call [_printf] \n\</span></div><div class="line"><span class="stringliteral">        add rsp, 5*8 \n\</span></div><div class="line"><span class="stringliteral">        ret \n\</span></div><div class="line"><span class="stringliteral">        _printf dq printf \n\</span></div><div class="line"><span class="stringliteral">        string db &#39;Hello world (from assembly)!&#39;, 13, 10, 0 \n\</span></div><div class="line"><span class="stringliteral">    &quot;</span>;</div><div class="line"><span class="preprocessor">#elif defined _WIN32</span></div><div class="line">    helloWorld = <span class="stringliteral">&quot;\</span></div><div class="line"><span class="stringliteral">        use32 \n\</span></div><div class="line"><span class="stringliteral">        call $+5 \n\</span></div><div class="line"><span class="stringliteral">        mov eax, [esp] \n\</span></div><div class="line"><span class="stringliteral">        add dword[esp], string-5 \n\</span></div><div class="line"><span class="stringliteral">        call [eax+_printf-5] \n\</span></div><div class="line"><span class="stringliteral">        add esp, 4 \n\</span></div><div class="line"><span class="stringliteral">        ret \n\</span></div><div class="line"><span class="stringliteral">        _printf dd printf \n\</span></div><div class="line"><span class="stringliteral">        string db &#39;Hello world (from assembly)!&#39;, 13, 10, 0 \n\</span></div><div class="line"><span class="stringliteral">    &quot;</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a6c8a3c1f474cea832620ca349bfafbc7">setAssembler</a>(&amp;assembler);</div><div class="line">    helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a302b52f86108409b025403e7bb342c04">addPredefinition</a>(<span class="stringliteral">&quot;printf&quot;</span>, printf);</div><div class="line"></div><div class="line">    high_resolution_clock::time_point before = high_resolution_clock::now();</div><div class="line">    <span class="keywordtype">bool</span> success = helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#aff60920cd801271fa67d52a106ebd2b8">assemble</a>();</div><div class="line">    high_resolution_clock::time_point after = high_resolution_clock::now();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (success)</div><div class="line">    {</div><div class="line">        std::cout &lt;&lt; helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a0fafb56ccefbe734bcf4bd5d94a5b2ff">getMessages</a>();</div><div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Successfully built code in &quot;</span> &lt;&lt;</div><div class="line">            duration_cast&lt;duration&lt;double, std::micro&gt;&gt;(after - before).count() &lt;&lt;</div><div class="line">            <span class="stringliteral">&quot; microseconds.\n&quot;</span>;</div><div class="line">        helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a09851233625bdcd5f357c1793e35254d">run</a>(<span class="keyword">false</span>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        std::cout &lt;&lt; helloWorld.<a class="code" href="classfasmcpp_1_1_assembly.html#a909faa2c985dd39abe77103dd66014d1">getErrors</a>() &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line"></div><div class="line">    std::cin.get();</div><div class="line">}</div></div><!-- fragment --><p>I hope this helped you get started with fasmcpp. You can take a look at other guides or at the reference. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
